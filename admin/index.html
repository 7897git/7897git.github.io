---
layout: default
permalink: /dashboard
---

<h1>Tambah Postingan Baru</h1>
<label>Nama File (tanpa .md):</label>
<input type="text" id="filename" placeholder="contoh: nama-produk">

<label>Isi Markdown:</label>
<textarea id="markdown-content" rows="10" cols="50"></textarea>

<button onclick="uploadMarkdown()">Upload</button>
<p id="upload-status"></p>

<button onclick="logout()">Logout</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getStorage, ref, uploadString, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "{{site.apiKey}}",
        authDomain: "{{site.authDomain}}",
        databaseURL: "{{site.databaseURL}}",
        projectId: "{{site.projectId}}",
        storageBucket: "{{site.storageBucket}}",
        messagingSenderId: "{{site.senderId}}",
        appId: "{{site.appId}}"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Cek autentikasi admin sebelum akses halaman
    onAuthStateChanged(auth, (user) => {
        if (!user || localStorage.getItem("adminLoggedIn") !== "true") {
            window.location.href = "{{site.baseurl}}/admin";
        }
    });

    // Fungsi Upload Markdown
    async function uploadMarkdown() {
        const filename = document.getElementById("filename").value.trim();
        const content = document.getElementById("markdown-content").value.trim();
        const statusEl = document.getElementById("upload-status");

        if (!filename || !content) {
            alert("Nama file dan isi markdown tidak boleh kosong!");
            return;
        }

        // Validasi nama file
        if (!/^[a-zA-Z0-9-_]+$/.test(filename)) {
            alert("Nama file hanya boleh mengandung huruf, angka, tanda '-' atau '_'");
            return;
        }

        const filePath = `posts/${filename}.md`;
        const fileRef = ref(storage, filePath);

        try {
            // Cek apakah file sudah ada
            const listRef = ref(storage, "posts");
            const files = await listAll(listRef);
            const existingFile = files.items.find(item => item.name === `${filename}.md`);

            if (existingFile) {
                alert("File dengan nama ini sudah ada!");
                return;
            }

            statusEl.innerText = "Mengupload...";
            await uploadString(fileRef, content);
            statusEl.innerText = "Upload berhasil!";

            alert("File Markdown berhasil diunggah!");
        } catch (error) {
            console.error("Upload gagal:", error);
            statusEl.innerText = "Gagal mengupload.";
            alert("Terjadi kesalahan saat mengupload file.");
        }
    }

    // Logout admin
    function logout() {
        signOut(auth).then(() => {
            localStorage.removeItem("adminLoggedIn");
            window.location.href = "{{site.baseurl}}/admin";
        });
    }
</script>
